# ccusage-rs 项目需求规格说明（改进版）

## 项目概述

ccusage-rs 是一个用 Rust 重写的 Claude Code 使用情况分析工具，用于分析本地 JSONL 文件中的 Claude Code token 使用情况和成本。基于代码质量验证报告（72分，未达到95%门槛），本规格说明重新调整了需求优先级和实现策略。

## 执行摘要

基于代码质量验证反馈，项目需要重新聚焦核心功能，采用渐进式开发策略。优先确保编译通过、基本功能实现和测试覆盖，再逐步添加高级功能。

## 质量验证反馈分析

### 主要问题
1. **编译错误（93个）**：模块依赖复杂、类型定义不完整、trait 实现缺失
2. **测试覆盖不足**：缺乏核心功能的单元测试和集成测试
3. **功能完整性问题**：过度设计导致核心功能不完整
4. **错误处理架构不完善**：缺乏统一的错误处理策略
5. **文档不完整**：缺乏实现指导和API文档

### 改进策略
- **简化架构**：减少不必要的抽象层，聚焦核心功能
- **分阶段实现**：先实现基础功能，再添加高级特性
- **测试驱动**：确保每个功能都有对应的测试
- **错误优先**：建立完善的错误处理机制

## 干系人

### 主要用户
- **开发者**: 使用 Claude Code 进行日常开发的软件工程师
- **团队负责人**: 需要监控团队 Claude Code 使用情况和成本的管理者
- **DevOps 工程师**: 负责工具部署和维护的技术人员

### 次要用户
- **财务人员**: 需要了解 AI 工具成本的财务分析师
- **系统管理员**: 管理开发环境和工具的系统管理员

## 功能需求（重新排序）

### FR-001: 基础编译和构建
**描述**: 确保项目能够成功编译和构建
**优先级**: 关键（Critical）
**验收标准**:
- [ ] 项目能够成功编译（0个编译错误）
- [ ] 所有依赖项正确解析
- [ ] 构建产物能够正常运行
- [ ] 跨平台构建支持（Linux、macOS、Windows）

### FR-002: 数据加载和解析
**描述**: 从 Claude Code 本地数据目录加载和解析使用数据
**优先级**: 高
**验收标准**:
- [ ] 自动检测 Claude Code 数据目录路径
- [ ] 高效解析 JSONL 格式的使用数据文件
- [ ] 处理损坏或格式错误的数据文件
- [ ] 基本的数据验证和清理
- [ ] 支持增量数据加载以提高性能

### FR-003: 基础分析功能
**描述**: 提供基本的 token 使用统计和成本计算
**优先级**: 高
**验收标准**:
- [ ] 计算总 token 使用量（输入/输出）
- [ ] 基本的成本计算（支持固定定价）
- [ ] 按日期分组的基本统计
- [ ] 简单的汇总报告
- [ ] 支持命令行参数配置

### FR-004: 核心报告功能
**描述**: 实现主要的报告类型（日报、月报、会话报告）
**优先级**: 高
**验收标准**:
- [ ] 支持按日期分组的日报功能
- [ ] 支持按月份分组的月报功能
- [ ] 支持按会话分组的会话报告
- [ ] 基本的表格格式输出
- [ ] 支持 JSON 格式输出

### FR-005: 错误处理和日志
**描述**: 建立完善的错误处理和日志系统
**优先级**: 高
**验收标准**:
- [ ] 统一的错误类型定义
- [ ] 优雅的错误处理和恢复
- [ ] 结构化的日志记录
- [ ] 用户友好的错误信息
- [ ] 调试模式支持

### FR-006: 测试覆盖
**描述**: 为核心功能提供全面的测试覆盖
**优先级**: 高
**验收标准**:
- [ ] 单元测试覆盖率达到 80% 以上
- [ ] 集成测试覆盖主要功能流程
- [ ] 性能测试验证关键指标
- [ ] 测试数据准备和模拟
- [ ] CI/CD 集成测试

### FR-007: 命令行界面
**描述**: 提供完整的命令行界面
**优先级**: 中
**验收标准**:
- [ ] 支持所有主要命令（daily、monthly、session）
- [ ] 完整的帮助信息和使用说明
- [ ] 参数验证和错误处理
- [ ] 支持配置文件和环境变量
- [ ] 兼容原版 ccusage 的主要参数

### FR-008: 高级分析功能
**描述**: 实现高级分析功能
**优先级**: 中
**验收标准**:
- [ ] 支持5小时计费块分析
- [ ] 支持周报功能
- [ ] 实时监控功能
- [ ] 高级过滤和排序
- [ ] 项目分组和别名支持

### FR-009: MCP 服务器集成
**描述**: 内置 Model Context Protocol 服务器支持
**优先级**: 低
**验收标准**:
- [ ] 支持 stdio 传输模式
- [ ] 暴露主要的分析工具
- [ ] 基本的错误处理
- [ ] 简单的配置支持

### FR-010: 性能优化
**描述**: 优化性能和资源使用
**优先级**: 低
**验收标准**:
- [ ] 启动时间 < 1秒
- [ ] 数据加载时间 < 3秒（100MB数据）
- [ ] 内存使用 < 50MB（正常运行）
- [ ] 支持大数据集处理
- [ ] 并发处理优化

## 非功能需求

### NFR-001: 编译质量
**描述**: 代码必须能够成功编译
**指标**:
- 编译错误数量：0
- 编译警告数量：< 10
- 代码格式符合 Rust 标准风格
- 所有依赖项正确解析

### NFR-002: 测试质量
**描述**: 必须有全面的测试覆盖
**指标**:
- 单元测试覆盖率 > 80%
- 集成测试覆盖率 > 60%
- 关键路径测试覆盖率 > 90%
- 所有测试必须通过
- 性能测试达到预期指标

### NFR-003: 代码质量
**描述**: 代码必须符合 Rust 最佳实践
**标准**:
- 遵循 Rust API 指导原则
- 正确的错误处理
- 内存安全保证
- 文档完整性
- 代码可维护性

### NFR-004: 可靠性
**描述**: 系统必须稳定可靠
**指标**:
- 崩溃率 < 0.1%
- 数据完整性保证
- 优雅的错误处理
- 自动恢复机制

### NFR-005: 兼容性
**描述**: 必须与原始 ccusage 工具兼容
**标准**:
- 支持相同的命令行参数
- 生成相同的输出格式
- 兼容相同的数据格式
- 支持相同的配置选项

## 技术约束

### 硬件约束
- 支持的操作系统：Linux、macOS、Windows
- 最小内存要求：128MB
- 最小存储空间：50MB

### 软件约束
- 编程语言：Rust (稳定版)
- 目标架构：x86_64, ARM64
- 依赖管理：Cargo
- 构建系统：Cargo

### 数据约束
- 输入格式：JSONL (Claude Code 使用数据)
- 配置格式：JSON/TOML
- 输出格式：表格、JSON
- 编码：UTF-8

## 假设

### 数据假设
- Claude Code 数据存储在标准位置（~/.claude 或 ~/.config/claude）
- 数据文件格式为 JSONL，每行包含一次 API 调用的使用数据
- 数据文件包含基本的 token 计数信息

### 环境假设
- 用户有权限访问 Claude Code 数据目录
- 系统有足够的内存处理数据文件
- Rust 开发环境已正确配置

### 功能假设
- 用户熟悉命令行工具的使用
- 用户了解 Claude Code 的基本概念
- 用户需要监控和控制 AI 工具使用成本

## 范围外功能

### 不在第一版本范围内的功能
- Web 界面或 GUI
- 云端数据存储或同步
- 多用户支持
- 高级数据分析和可视化
- 第三方服务集成（除 MCP 外）
- 移动应用支持
- 国际化支持（多语言）
- 高级性能优化

### 可能的未来扩展
- 支持 AI 模型（除 Claude 外）
- 团队协作功能
- 预算管理和警报
- 历史趋势分析
- 自定义报告生成
- 插件系统

## 数据模型（简化版）

### 使用数据条目
```rust
struct UsageEntry {
    timestamp: DateTime<Utc>,
    model: String,
    usage: TokenUsage,
    cost_usd: Option<f64>,
    session_id: Option<String>,
    project_path: Option<String>,
}
```

### Token 使用统计
```rust
struct TokenUsage {
    input_tokens: u64,
    output_tokens: u64,
    cache_creation_input_tokens: Option<u64>,
    cache_read_input_tokens: Option<u64>,
}
```

### 报告数据结构
```rust
struct DailyUsage {
    date: NaiveDate,
    input_tokens: u64,
    output_tokens: u64,
    total_cost: f64,
    models_used: Vec<String>,
}
```

## 命令结构

### 核心命令（第一版本）
- `ccusage-rs daily` - 日报（默认命令）
- `ccusage-rs monthly` - 月报
- `ccusage-rs session` - 会话报告

### 全局选项
- `--json` - JSON 输出格式
- `--since` - 开始日期过滤
- `--until` - 结束日期过滤
- `--debug` - 调试模式
- `--help` - 帮助信息
- `--version` - 版本信息

### 命令特定选项
- `daily`: `--project`, `--model`
- `monthly`: `--year`, `--order`
- `session`: `--id`, `--limit`

## 验收标准（重新定义）

### 编译验收
- 所有源文件必须能够成功编译
- 编译器警告数量必须 < 10
- 所有依赖项必须正确解析
- 跨平台编译必须成功

### 功能验收
- 核心命令必须正常工作
- 输出格式必须正确
- 错误处理必须优雅
- 性能指标必须达标

### 测试验收
- 单元测试覆盖率 > 80%
- 所有测试必须通过
- 性能测试必须达标
- 集成测试必须通过

### 质量验收
- 代码质量符合 Rust 最佳实践
- 文档完整准确
- 错误处理完善
- 用户体验良好

## 风险评估

### 技术风险
- **复杂性管理**: 项目复杂度可能导致维护困难
  - **缓解**: 简化架构，模块化设计
- **性能问题**: 大数据集处理可能存在性能问题
  - **缓解**: 早期性能测试，算法优化
- **兼容性**: 与原版本的兼容性可能难以完全实现
  - **缓解**: 详细的兼容性测试

### 项目风险
- **范围蔓延**: 功能范围可能不断扩大
  - **缓解**: 严格的需求管理，分阶段实现
- **时间压力**: 开发时间可能不足
  - **缓解**: 优先级管理，MVP优先
- **质量保证**: 代码质量可能不达标
  - **缓解**: 代码审查，自动化测试

## 成功标准

### 技术成功
- 项目能够成功编译和运行
- 核心功能正常工作
- 性能指标达到预期
- 代码质量符合标准

### 用户成功
- 用户能够成功使用工具
- 功能满足基本需求
- 用户体验良好
- 工具稳定可靠

### 项目成功
- 项目按时交付
- 质量门槛达到95%以上
- 维护和扩展性强
- 社区接受度高

## 分阶段实现计划

### 阶段1: 基础架构（Week 1-2）
- 设置项目结构和依赖
- 实现基本的数据结构
- 建立错误处理框架
- 实现基础的日志系统

### 阶段2: 核心功能（Week 3-4）
- 实现数据加载和解析
- 实现基本的统计分析
- 实现核心命令（daily、monthly、session）
- 实现基本的输出格式

### 阶段3: 测试和质量（Week 5-6）
- 编写全面的单元测试
- 实现集成测试
- 性能测试和优化
- 代码审查和重构

### 阶段4: 高级功能（Week 7-8）
- 实现高级分析功能
- 实现MCP服务器
- 实现实时监控
- 完善文档和示例

### 阶段5: 验收和发布（Week 9-10）
- 完整的功能测试
- 性能基准测试
- 兼容性测试
- 用户验收测试

## 附录

### 术语表
- **JSONL**: JSON Lines，每行一个 JSON 对象的文本格式
- **Token**: AI 模型处理的基本单位
- **Cache Token**: 缓存相关的 token 计数
- **MCP**: Model Context Protocol，模型上下文协议
- **MVP**: Minimum Viable Product，最小可行产品

### 参考资料
- [原始 ccusage 项目](https://github.com/ryoppippi/ccusage)
- [Claude Code 文档](https://docs.anthropic.com/claude-code)
- [Rust 编程语言](https://www.rust-lang.org/)
- [MCP 规范](https://modelcontextprotocol.io/)

### 相关标准
- [JSON 标准](https://www.json.org/json-en.html)
- [JSONL 格式](http://jsonlines.org/)
- [RFC 3339](https://tools.ietf.org/html/rfc3339) - 日期时间格式
- [Unicode 标准](https://unicode.org/standard/standard.html)
- [Rust API 指导原则](https://rust-lang.github.io/api-guidelines/)